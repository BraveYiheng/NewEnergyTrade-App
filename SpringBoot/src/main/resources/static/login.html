<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/vue@3.4.27/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios@1.7.2/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.css">
    <title>ç”¨æˆ·ç™»å½•æ³¨å†Œ</title>
    <link rel="stylesheet" type="text/css" href="../css/login.css">
    <style>
        body {
            background: #f5f7fa;
        }
        .center-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .form-card {
            background: #fff;
            border-radius: 24px;
            box-shadow: 0 6px 32px 0 rgba(0,0,0,0.08);
            padding: 48px 40px 36px 40px;
            width: 410px;
            max-width: 98vw;
            position: relative;
            transition: box-shadow 0.3s;
        }
        .form-card h1 {
            text-align: center;
            margin-bottom: 32px;
            color: #409EFF;
            font-size: 2.3rem;
            font-weight: 800;
            letter-spacing: 2px;
        }
        label {
            font-weight: 600;
            font-size: 1.08rem;
            margin-bottom: 8px;
            margin-top: 10px;
            display: block;
            color: #333;
        }
        .switch-link {
            color: #409EFF;
            cursor: pointer;
            text-align: center;
            margin-top: 18px;
            display: block;
            font-size: 16px;
            transition: color 0.2s;
        }
        .switch-link:hover {
            color: #66b1ff;
            text-decoration: underline;
        }
        .error-message {
            color: #f56c6c;
            font-size: 12px;
            margin-bottom: 4px;
            margin-top: -4px;
            display: block;
            letter-spacing: 0.5px;
        }
        input[type="text"], input[type="email"], input[type="password"], select {
            border-radius: 12px;
            border: 1.5px solid #dcdfe6;
            transition: border-color 0.2s, box-shadow 0.2s;
            margin-bottom: 14px;
            height: 44px;
            font-size: 1.08rem;
            padding: 0 16px;
            background: #f8fafc;
        }
        input:focus, select:focus {
            border-color: #409EFF;
            box-shadow: 0 0 0 2px #ecf5ff;
            background: #fff;
        }
        input.error, select.error {
            border-color: #f56c6c;
            background: #fff0f0;
        }
        button[type="submit"], button[type="button"] {
            width: 100%;
            border-radius: 22px;
            font-size: 1.15rem;
            margin-top: 18px;
            padding: 12px 0;
            background: linear-gradient(90deg, #409EFF 60%, #66b1ff 100%);
            color: #fff;
            font-weight: 700;
            border: none;
            box-shadow: 0 2px 8px rgba(64,158,255,0.08);
            transition: background 0.2s, box-shadow 0.2s;
        }
        button[type="submit"]:hover:not(:disabled) {
            background: linear-gradient(90deg, #66b1ff 60%, #409EFF 100%);
            box-shadow: 0 4px 16px rgba(64,158,255,0.13);
        }
        button:disabled {
            background: #b3d8ff;
            color: #fff;
            cursor: not-allowed;
        }
        .password-row {
            display: flex;
            align-items: center;
            position: relative;
        }
        .password-row input {
            flex: 1;
            padding-right: 40px;
        }
        .password-toggle {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #bbb;
            font-size: 20px;
        }
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.4s;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        .message-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 9999;
            background: #409EFF;
            color: #fff;
            text-align: center;
            padding: 12px 0;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(64,158,255,0.1);
            display: none;
        }
        .message-bar.show {
            display: block;
        }
        @media (max-width: 600px) {
            .form-card {
                padding: 18px 4vw 12px 4vw;
                width: 99vw;
            }
            .form-card h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>
<div class="center-container">
<div id="app">
    <div :class="['message-bar', messageBar.show ? 'show' : '']">{{ messageBar.text }}</div>
    <!-- ç™»å½•é¡µé¢ -->
    <transition name="fade">
    <div class="form-card" v-show="showLogin">
        <h1>ç”¨æˆ·ç™»å½•</h1>
        <form @submit.prevent="login">
            <label for="login-email">é‚®ç®±ï¼š</label>
            <input type="email" id="login-email" v-model="loginForm.email" @blur="validateLoginEmail" :class="{'error': loginEmailError}">
            <span v-if="loginEmailError" class="error-message">{{ loginEmailError }}</span>
            <label for="login-password">å¯†ç ï¼š</label>
            <div style="position:relative;">
                <input :type="showLoginPassword ? 'text' : 'password'" id="login-password" v-model="loginForm.password" @blur="validateLoginPassword" :class="{'error': loginPasswordError}" style="padding-right:36px;">
                <span class="password-toggle" @click="showLoginPassword = !showLoginPassword">
                    <span v-if="showLoginPassword">ğŸ™ˆ</span>
                    <span v-else>ğŸ‘ï¸</span>
                </span>
            </div>
            <span v-if="loginPasswordError" class="error-message">{{ loginPasswordError }}</span>
            <button type="submit" :disabled="loginLoading">{{ loginLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}</button>
            <p class="switch-link" @click="showRegisterForm">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ</p>
        </form>
    </div>
    </transition>
    <!-- æ³¨å†Œé¡µé¢ -->
    <transition name="fade">
    <div class="form-card" v-show="showRegister">
        <h1>ç”¨æˆ·æ³¨å†Œ</h1>
        <form @submit.prevent="register">
            <label for="companyName">ä¼ä¸šåç§°ï¼š</label>
            <input type="text" id="companyName" v-model="registerForm.companyName" @blur="validateCompanyName" :class="{'error': companyNameError}">
            <span v-if="companyNameError" class="error-message">{{ companyNameError }}</span>
            <label for="contactPerson">è”ç³»äººï¼š</label>
            <input type="text" id="contactPerson" v-model="registerForm.contactPerson" @blur="validateContactPerson" :class="{'error': contactPersonError}">
            <span v-if="contactPersonError" class="error-message">{{ contactPersonError }}</span>
            <label for="contactNumber">è”ç³»æ–¹å¼ï¼š</label>
            <input type="text" id="contactNumber" v-model="registerForm.contactNumber" @blur="validateContactNumber" :class="{'error': contactNumberError}">
            <span v-if="contactNumberError" class="error-message">{{ contactNumberError }}</span>
            <label for="register-email">é‚®ç®±ï¼š</label>
            <input type="text" id="register-email" v-model="registerForm.email" @blur="checkEmailExist" :class="{'error': registerEmailError}">
            <span v-if="registerEmailError" class="error-message">{{ registerEmailError }}</span>
            <label for="register-password">å¯†ç ï¼š</label>
            <div class="password-row">
                <input :type="showRegisterPassword ? 'text' : 'password'" id="register-password" v-model="registerForm.password" @blur="validateRegisterPassword" :class="{'error': registerPasswordError}">
                <span class="password-toggle" @click="showRegisterPassword = !showRegisterPassword">
                    <span v-if="showRegisterPassword">ğŸ™ˆ</span>
                    <span v-else>ğŸ‘ï¸</span>
                </span>
            </div>
            <span v-if="registerPasswordError" class="error-message">{{ registerPasswordError }}</span>
            <label for="role">è§’è‰²ï¼š</label>
            <select id="role" v-model="registerForm.role" @change="validateRole" :class="{'error': roleError}">
                <option value="0">ä¾›åº”å•†</option>
                <option value="1">é‡‡è´­å•†</option>
            </select>
            <span v-if="roleError" class="error-message">{{ roleError }}</span>
            <button type="submit" :disabled="registerButtonDisabled || registerLoading">{{ registerLoading ? 'æ³¨å†Œä¸­...' : 'æ³¨å†Œ' }}</button>
            <p class="switch-link" @click="showLoginForm">å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•</p>
        </form>
    </div>
    </transition>
</div>
</div>
<script>
    const { createApp } = Vue;

    // æå–é€šç”¨çš„é‚®ç®±æ ¼å¼éªŒè¯å‡½æ•°
    function validateEmail(email) {
        return /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email);
    }

    createApp({
        data() {
            return {
                // ç™»å½•è¡¨å•æ•°æ®åŠé”™è¯¯ä¿¡æ¯
                loginForm: {
                    email: '',
                    password: ''
                },
                loginEmailError: '',
                loginPasswordError: '',
                // æ³¨å†Œè¡¨å•æ•°æ®åŠé”™è¯¯ä¿¡æ¯
                registerForm: {
                    companyName: '',
                    contactPerson: '',
                    contactNumber: '',
                    email: '',
                    password: '',
                    role: null
                },
                companyNameError: '', //ä¸ºç©ºå­—ç¬¦ä¸²æ—¶ä¸æ¸²æŸ“æ˜¾ç¤º
                contactPersonError: '',
                contactNumberError: '',
                registerEmailError: '',
                registerPasswordError: '',
                roleError: '',
                // ç”¨äºæ§åˆ¶æ˜¾ç¤ºç™»å½•é¡µé¢è¿˜æ˜¯æ³¨å†Œé¡µé¢
                showLogin: true,
                showRegister: false,
                showLoginPassword: false,
                showRegisterPassword: false,
                loginLoading: false,
                registerLoading: false,
                registerButtonDisabled: false,
                messageBar: { show: false, text: '' }
            }
        },
        methods: {
            showMessage(msg) {
                this.messageBar.text = msg;
                this.messageBar.show = true;
                setTimeout(() => { this.messageBar.show = false; }, 2000);
            },
            // ç™»å½•è¡¨å•éªŒè¯æ–¹æ³•ï¼Œä½¿ç”¨æå–çš„é‚®ç®±éªŒè¯å‡½æ•°
            validateLoginEmail() {
                if (!this.loginForm.email.trim()) {
                    this.loginEmailError = 'è¯·è¾“å…¥é‚®ç®±åœ°å€';
                } else if (!validateEmail(this.loginForm.email)) {
                    this.loginEmailError = 'è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼';
                } else {
                    this.loginEmailError = '';
                }
            },
            validateLoginPassword() {
                if (!this.loginForm.password.trim()) {
                    this.loginPasswordError = 'è¯·è¾“å…¥å¯†ç ';
                } else if (this.loginForm.password.length < 6) {
                    this.loginPasswordError = 'å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½';
                } else {
                    this.loginPasswordError = '';
                }
            },
            // æ³¨å†Œè¡¨å•éªŒè¯æ–¹æ³•ï¼Œä½¿ç”¨æå–çš„é‚®ç®±éªŒè¯å‡½æ•°
            validateCompanyName() {
                if (!this.registerForm.companyName.trim()) {
                    this.companyNameError = 'è¯·è¾“å…¥ä¼ä¸šåç§°';
                } else {
                    this.companyNameError = '';
                }
            },
            validateContactPerson() {
                if (!this.registerForm.contactPerson.trim()) {
                    this.contactPersonError = 'è¯·è¾“å…¥è”ç³»äººå§“å';
                } else {
                    this.contactPersonError = '';
                }
            },
            validateContactNumber() {
                const phonePattern = /^1[3-9]\d{9}$/;
                if (!this.registerForm.contactNumber.trim()) {
                    this.contactNumberError = 'è¯·è¾“å…¥æ‰‹æœºå·';
                } else if (!phonePattern.test(this.registerForm.contactNumber)) {
                    this.contactNumberError = 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®';
                } else {
                    this.contactNumberError = '';
                }
            },
            validateRegisterPassword() {
                if (!this.registerForm.password.trim()) {
                    this.registerPasswordError = 'è¯·è¾“å…¥å¯†ç ';
                } else if (this.registerForm.password.length < 6) {
                    this.registerPasswordError = 'å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½';
                } else {
                    this.registerPasswordError = '';
                }
            },
            validateRole() {
                if (this.registerForm.role === null) {
                    this.roleError = 'è¯·é€‰æ‹©è§’è‰²';
                } else {
                    this.roleError = '';
                }
            },
            // ç™»å½•é€»è¾‘ï¼Œæ·»åŠ æ ¹æ®è§’è‰²è·³è½¬é¡µé¢çš„åŠŸèƒ½
            async login() {
                this.validateLoginEmail();
                this.validateLoginPassword();
                if (!this.loginEmailError &&!this.loginPasswordError) {
                    this.loginLoading = true;
                    try {
                        const loginForm = {
                            email: this.loginForm.email,
                            password: this.loginForm.password
                        };
                        const response = await axios.post('/user/login', loginForm);
                        if (response.data.success) {
                            const user= response.data.user;
                            console.log(user);
                            let targetUrl = '';
                            if(response.data.user.role == 0){
                                targetUrl = '/supplier/supplier.html';
                            }
                            else if(response.data.user.role == 1){
                                targetUrl = '/purchaser/purchaser.html';
                            }
                            window.location.href = `${targetUrl}?id=${user.userId}`;
                        }
                        else {
                            this.showMessage(response.data.message);
                        }
                    } catch (error) {
                        console.error(error);
                        this.showMessage('ç™»å½•å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åå†è¯•');
                    }
                    this.loginLoading = false;
                }
            },
            // æ³¨å†Œé€»è¾‘
            async register() {
                this.validateCompanyName();
                this.validateContactPerson();
                this.validateContactNumber();
                this.validateRegisterPassword();
                this.validateRole();
                if (!this.companyNameError &&!this.contactPersonError &&!this.contactNumberError &&!this.registerPasswordError &&!this.roleError) {
                    this.registerLoading = true;
                    try {
                        const response = await axios.post('/user/register', this.registerForm);
                        if (response.data) {
                            this.showMessage('æ³¨å†ŒæˆåŠŸï¼Œ2ç§’åè·³è½¬ç™»å½•é¡µé¢');
                            setTimeout(() => {
                                this.showLoginForm();
                            }, 2000);
                        }
                        else {
                            this.showMessage('æ³¨å†Œå¤±è´¥');
                        }
                    } catch (error) {
                        console.error(error);
                        this.showMessage('æ³¨å†Œå‡ºç°é”™è¯¯ï¼Œè¯·ç¨åå†è¯•');
                    }
                    this.registerLoading = false;
                }
            },
            // åˆ‡æ¢æ˜¾ç¤ºç™»å½•é¡µé¢æ–¹æ³•
            showLoginForm() {
                this.showLogin = true;
                this.showRegister = false;
            },
            // åˆ‡æ¢æ˜¾ç¤ºæ³¨å†Œé¡µé¢æ–¹æ³•
            showRegisterForm() {
                this.showLogin = false;
                this.showRegister = true;
            },
            // æ³¨å†Œæ—¶é‚®ç®±éªŒè¯é€»è¾‘ï¼Œä¿®æ­£è¯·æ±‚åœ°å€æ‹¼æ¥é—®é¢˜
            async checkEmailExist() {
                const email = this.registerForm.email;
                // å…ˆä½¿ç”¨éªŒè¯å‡½æ•°éªŒè¯é‚®ç®±æ ¼å¼æ˜¯å¦æ­£ç¡®
                if (!validateEmail(email)) {
                    this.registerEmailError = 'è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼';
                    this.registerButtonDisabled = true;
                    return;
                }
                try {
                    const url ='/user/checkEmail?email='+this.registerForm.email;
                    const response = await axios.get(url);
                    if (response.data) {
                        this.registerEmailError = 'è¯¥é‚®ç®±å·²å­˜åœ¨ï¼Œè¯·ç™»å½•';
                        // å½“é‚®ç®±å­˜åœ¨æ—¶ï¼Œè®¾ç½®æ³¨å†ŒæŒ‰é’®ä¸ºç¦ç”¨çŠ¶æ€
                        this.registerButtonDisabled = true;
                    } else {
                        this.registerEmailError = '';
                        this.registerButtonDisabled = false;
                    }
                } catch (error) {
                    console.error(error);
                    this.registerEmailError = 'éªŒè¯é‚®ç®±æ˜¯å¦å­˜åœ¨æ—¶å‡ºé”™ï¼Œè¯·ç¨åå†è¯•';
                    this.registerButtonDisabled = true;
                }
            }
        }
    }).mount('#app');
</script>
</body>

</html>